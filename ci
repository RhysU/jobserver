#!/bin/bash -eu
# Run uv-based continuous integration tests for jobserver/
#
# Usage: ./ci [--python VERSION]
# Example: ./ci --python 3.8

PYTHON_FLAG=""
if [ "${1:-}" = "--python" ] && [ -n "${2:-}" ]; then
    PYTHON_FLAG="--python $2"
fi

# Unit testing runs the tests inside jobserver/test.py
uv run $PYTHON_FLAG -m unittest -v jobserver.test

# Unit testing runs the draft executor tests
uv run $PYTHON_FLAG -m unittest -v draft.test_executor

# Run all examples to confirm they complete successfully
for ex in examples/*.py; do
    PYTHONPATH=. uv run $PYTHON_FLAG "$ex"
done

# PEP8 linting
uvx --from flake8 flake8 jobserver/ draft/ examples/

# Typehint linting requires a new-enough mypy
uvx --from "mypy>0.770" mypy jobserver/ draft/

# Finally, check for formatting issues
uvx --from "black<25" black --check --line-length 79 --verbose jobserver/ draft/ examples/
