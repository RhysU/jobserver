#!/bin/bash -eu
# Run continuous integration tests for jobserver.py
# Installs any necessary prerequisites using python -m pip.
# Tools like flake8, black, etc all invoked via python -m.
# Intended for use with CircleCI or Conda or VirtualEnv

# Informational and helpful when developing against multiple Python versions
echo "$(command -v python): $(python -V)"
set -x

# Unit testing runs the tests inside jobserver.py
python -m unittest -v jobserver

# PEP8 linting
python -m pip install flake8
python -m flake8 jobserver.py

# Typehint linting requires a new-enough mypy
python -m pip install "mypy>0.770"
python -m mypy jobserver.py

# Finally, check for formatting issues sidestepping a Black-on-Python-3.7 nit
set -o pipefail
python -m pip install black
if python --version | grep --invert-match '^Python 3.7.'; then
    python -m black --check --line-length 79 jobserver.py
fi
